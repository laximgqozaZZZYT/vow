import { rmSync, mkdirSync, cpSync, existsSync, writeFileSync, readFileSync } from 'node:fs'
import path from 'node:path'

/**
 * Create two deployable Lambda zip artifacts:
 * - lambda-api.zip: API handler + runtime deps (no prisma CLI, no migrations)
 * - lambda-migrate.zip: migrate handler + prisma CLI + prisma schema/migrations
 *
 * Assumptions:
 * - `npm run build:bundle` has been run and produced `dist-bundle/`.
 * - `npm prune --omit=dev` has been run (so node_modules only contains prod deps).
 *
 * Why we do this:
 * - API Lambda doesn't need prisma CLI; excluding it reduces zip size and coldstart IO.
 */

const repoRoot = path.resolve(new URL('..', import.meta.url).pathname)
const distBundle = path.join(repoRoot, 'dist-bundle')
if (!existsSync(distBundle)) {
  console.error('Missing dist-bundle/. Run: npm run build:bundle')
  process.exit(1)
}

const apiDir = path.join(repoRoot, '.lambda-artifact-api')
const migrateDir = path.join(repoRoot, '.lambda-artifact-migrate')

for (const dir of [apiDir, migrateDir]) {
  rmSync(dir, { recursive: true, force: true })
  mkdirSync(dir, { recursive: true })
}

// Shared copies
cpSync(distBundle, path.join(apiDir, 'dist'), { recursive: true })
cpSync(distBundle, path.join(migrateDir, 'dist'), { recursive: true })
cpSync(path.join(repoRoot, 'package.json'), path.join(apiDir, 'package.json'))
cpSync(path.join(repoRoot, 'package.json'), path.join(migrateDir, 'package.json'))

// Migrate needs schema/migrations
cpSync(path.join(repoRoot, 'prisma'), path.join(migrateDir, 'prisma'), { recursive: true })

// --- node_modules handling ---
// Migrate: include node_modules as-is (prod-only assumed)
cpSync(path.join(repoRoot, 'node_modules'), path.join(migrateDir, 'node_modules'), { recursive: true })

// API: copy node_modules but remove prisma CLI (if present)
cpSync(path.join(repoRoot, 'node_modules'), path.join(apiDir, 'node_modules'), { recursive: true })

const prismaCliDir = path.join(apiDir, 'node_modules', 'prisma')
if (existsSync(prismaCliDir)) {
  rmSync(prismaCliDir, { recursive: true, force: true })
}

// Prisma client runtime is needed in both.
// We intentionally do NOT remove @prisma/client.

// Create a tiny README inside artifacts for clarity when inspecting in S3.
const note = (kind) => `vow lambda artifact (${kind})\nGenerated by backend/scripts/make-artifacts.mjs\n\nContains:\n- dist/ (bundled handlers)\n- node_modules/ (prod deps)\n${kind === 'migrate' ? '- prisma/ (schema + migrations)\n- prisma CLI\n' : '- prisma CLI removed (API does not need it)\n'}\n`
writeFileSync(path.join(apiDir, 'ARTIFACT.txt'), note('api'))
writeFileSync(path.join(migrateDir, 'ARTIFACT.txt'), note('migrate'))

console.log('Created artifact folders:')
console.log('-', path.relative(repoRoot, apiDir))
console.log('-', path.relative(repoRoot, migrateDir))
