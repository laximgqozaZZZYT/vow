generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Goal {
  id        String    @id @default(cuid())
  name      String
  details   String?
  dueDate   DateTime?
  isCompleted Boolean @default(false)
  parentId  String?
  // Owner fields: support both authenticated users and anonymous guests.
  ownerType String?   // 'user' | 'guest'
  ownerId   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  parent    Goal?     @relation("GoalParent", fields: [parentId], references: [id])
  children  Goal[]    @relation("GoalParent")
  habits    Habit[]
  diaryCards DiaryCardGoal[]

  @@index([parentId], map: "Goal_parentId_fkey")
  @@index([ownerType, ownerId])
}

model Habit {
  id               String    @id @default(cuid())
  goalId           String
  name             String
  active           Boolean   @default(true)
  type             String
  count            Int       @default(0)
  must             Int?
  duration         Int?
  reminders        Json?
  dueDate          DateTime?
  time             String?
  endTime          String?
  repeat           String?
  timings          Json?
  outdates         Json?
  allDay           Boolean?
  notes            String?
  workloadUnit     String?
  workloadTotal    Int?
  workloadPerCount Int?
  completed        Boolean?  @default(false)
  lastCompletedAt  DateTime?
  ownerType        String?   // 'user' | 'guest'
  ownerId          String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  goal             Goal      @relation(fields: [goalId], references: [id])
  diaryCards        DiaryCardHabit[]
  @@index([goalId], map: "Habit_goalId_fkey")
  @@index([ownerType, ownerId])
}

model Activity {
  id              String   @id @default(cuid())
  kind            String
  habitId         String
  habitName       String?
  timestamp       DateTime @default(now())
  amount          Int?
  prevCount       Int?
  newCount        Int?
  durationSeconds Int?
  ownerType       String?  // 'user' | 'guest'
  ownerId         String?

  @@index([ownerType, ownerId])
}

model Preference {
  id        String   @id @default(cuid())
  key       String
  value     Json
  ownerType String?  // 'user' | 'guest'
  ownerId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, ownerType, ownerId])
  @@index([ownerType, ownerId])
}

// Diary feature
model DiaryCard {
  id        String   @id @default(cuid())
  // Markdown content (front/back)
  frontMd   String   @db.Text
  backMd    String   @db.Text

  ownerType String?  // 'user' | 'guest'
  ownerId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tags      DiaryCardTag[]
  goals     DiaryCardGoal[]
  habits    DiaryCardHabit[]

  @@index([ownerType, ownerId])
  @@index([createdAt])
}

model DiaryTag {
  id        String   @id @default(cuid())
  name      String
  color     String?
  ownerType String?  // 'user' | 'guest'
  ownerId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cards     DiaryCardTag[]

  @@unique([ownerType, ownerId, name])
  @@index([ownerType, ownerId])
}

model DiaryCardTag {
  id        String   @id @default(cuid())
  cardId    String
  tagId     String
  ownerType String?  // 'user' | 'guest'
  ownerId   String?
  createdAt DateTime @default(now())

  card      DiaryCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  tag       DiaryTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([cardId, tagId])
  @@index([ownerType, ownerId])
  @@index([tagId])
}

model DiaryCardGoal {
  id        String   @id @default(cuid())
  cardId    String
  goalId    String
  ownerType String?  // 'user' | 'guest'
  ownerId   String?
  createdAt DateTime @default(now())

  card      DiaryCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  goal      Goal      @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@unique([cardId, goalId])
  @@index([ownerType, ownerId])
  @@index([goalId])
}

model DiaryCardHabit {
  id        String   @id @default(cuid())
  cardId    String
  habitId   String
  ownerType String?  // 'user' | 'guest'
  ownerId   String?
  createdAt DateTime @default(now())

  card      DiaryCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  habit     Habit     @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([cardId, habitId])
  @@index([ownerType, ownerId])
  @@index([habitId])
}

model User {
  id         String       @id @default(cuid())
  email      String       @unique
  passwordHash String
  name       String?
  // If you use Supabase Auth, map its user.id (UUID) here.
  supabaseUserId String? @unique
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  oauthAccounts OAuthAccount[]
}

model Guest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  // If the guest has been merged into a user, keep the link for audit/debug.
  mergedIntoUserId String?
  mergedAt DateTime?
}

model Session {
  id        String   @id @default(cuid())
  // Exactly one of these is set.
  userId    String?
  guestId   String?
  createdAt DateTime @default(now())
  expiresAt DateTime

  // Note: we intentionally don't add Prisma relations here to keep migrations simple
  // and avoid cascading deletes surprises.
  @@index([userId])
  @@index([guestId])
}

model OAuthAccount {
  id         String   @id @default(cuid())
  provider   String
  // Provider-specific account id (Google "sub", GitHub user id, etc)
  providerAccountId String

  userId     String
  user       User     @relation(fields: [userId], references: [id])

  // Optional tokens (store only if you need API access). Keep nullable.
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model OAuthState {
  id           String   @id @default(cuid())
  provider     String
  state        String   @unique
  codeVerifier String
  // If the user started OAuth while being a guest, remember it for merge.
  guestId      String?
  createdAt    DateTime @default(now())
  expiresAt    DateTime

  @@index([provider])
  @@index([guestId])
}
