# セキュリティガイド

## 🔒 認証システム

### 現在の実装状況

✅ **完了済み**
- X-User-Id認証の完全削除
- Supabase JWT認証のみへの移行
- 適切なCORS設定
- JWT署名検証の強化
- セキュリティテストスクリプトの実装
- セッションCookieベースの認証実装

⚠️ **修正が必要**
- Next.js API Routesでのセッション転送処理
- 本番環境でのSupabaseクライアント制御
- React Error #418の解消

### 認証フロー

**開発環境**:
```
1. ユーザーがSupabase Authでログイン (Google OAuth)
   ↓
2. Supabase JWTトークンを取得
   ↓
3. フロントエンドがBearerトークンとしてAPIに送信
   ↓
4. バックエンドでJWT署名を検証
   ↓
5. ユーザー情報をデータベースにマッピング
```

**本番環境**:
```
1. ユーザーがSupabase Authでログイン (Google OAuth)
   ↓
2. バックエンドでセッションCookieを設定
   ↓
3. フロントエンドがNext.js API Routesを呼び出し
   ↓
4. Next.js API RoutesがセッションCookieをバックエンドに転送
   ↓
5. バックエンドでセッション検証とデータ処理
```

## 🛡️ セキュリティ対策

### JWT認証
- **JWKS URL**: Supabaseの公開鍵で署名検証
- **キャッシング**: 10分間、最大5エントリ
- **タイムアウト**: 30秒
- **レート制限**: 1分間に5リクエスト
- **クロック許容**: 30秒のスキュー許容

### CORS設定
- **開発環境**: localhost:3000, 3001, 5173を許可
- **本番環境**: 実際のドメインのみ許可
- **クレデンシャル**: 本番環境で有効
- **メソッド**: GET, POST, PATCH, DELETE, OPTIONS
- **ヘッダー**: content-type, authorization

### セッション管理
- **HttpOnly**: JavaScriptからのアクセス防止
- **Secure**: HTTPS環境で有効（本番環境）
- **SameSite**: CSRF攻撃防止
- **TTL**: 30日間
- **転送**: Next.js API Routes経由でバックエンドに転送

### パスワードセキュリティ
- **ハッシング**: bcrypt 10ラウンド
- **最小長**: 8文字（フロントエンドで検証）

## 🧪 セキュリティテスト

### 基本セキュリティテスト
```bash
npm run security-test
```

テスト項目:
- X-User-Id認証の無効化確認
- 無効なBearerトークンの拒否
- CORS設定の検証
- 悪意のあるオリジンのブロック
- SQLインジェクション対策
- XSS対策
- レート制限（基本チェック）

### ペネトレーションテスト
```bash
npm run penetration-test
```

テスト項目:
- JWT None Algorithm攻撃
- JWT秘密鍵ブルートフォース
- SQLインジェクション（高度）
- NoSQLインジェクション
- セッション固定攻撃
- CORS設定不備
- 情報漏洩チェック
- レート制限回避

### 全セキュリティテスト実行
```bash
npm run security-full
```

## 🚨 本番デプロイ前チェックリスト

### 必須設定
- [ ] `NODE_ENV=production`
- [ ] `VOW_COOKIE_SECURE=true`
- [ ] CORS_ORIGINSに本番ドメインのみ設定
- [ ] Supabase JWT設定の確認
- [ ] HTTPS証明書の設定
- [ ] セキュリティヘッダーの設定
- [ ] Next.js API Routesのセッション転送処理実装

### 推奨設定
- [ ] レート制限の実装
- [ ] アカウントロックアウト機能
- [ ] ログ監視の設定
- [ ] セキュリティアラートの設定
- [ ] 定期的なセキュリティスキャン
- [ ] React Error #418の解消

## 🔧 セキュリティ強化オプション

### 外部プラットフォーム活用

#### Supabase Auth（現在使用中）
- ✅ OAuth統合 (Google, GitHub)
- ✅ JWT署名検証
- ✅ セッション管理
- ✅ パスワードリセット
- ✅ メール認証

#### 追加検討可能なサービス

**Cloudflare**
- DDoS攻撃防御
- WAF (Web Application Firewall)
- レート制限
- Bot管理

**Supabase Auth**（将来的な選択肢）
- エンタープライズSSO
- 多要素認証
- 異常検知
- コンプライアンス対応

## 📊 セキュリティ監視

### ログ監視項目
- 認証失敗の頻度
- 異常なAPIアクセスパターン
- CORS違反
- JWT検証エラー
- レート制限違反

### アラート設定
- 短時間での大量ログイン失敗
- 未知のIPからの管理者アクセス
- 異常なデータアクセス量
- セキュリティテスト失敗

## 🔄 定期メンテナンス

### 月次
- [ ] セキュリティテストの実行
- [ ] 依存関係の脆弱性チェック
- [ ] ログの分析
- [ ] アクセスパターンの確認

### 四半期
- [ ] ペネトレーションテストの実行
- [ ] セキュリティ設定の見直し
- [ ] 脅威モデルの更新
- [ ] インシデント対応計画の確認

### 年次
- [ ] 外部セキュリティ監査
- [ ] コンプライアンス確認
- [ ] セキュリティ研修
- [ ] 災害復旧計画の確認

## 🆘 インシデント対応

### セキュリティ侵害の疑いがある場合
1. **即座に実行**
   - 影響範囲の特定
   - 攻撃の停止
   - 証拠の保全

2. **短期対応**
   - ユーザーへの通知
   - パスワードリセットの強制
   - システムの一時停止

3. **長期対応**
   - 根本原因の分析
   - セキュリティ対策の強化
   - 再発防止策の実装

## 📞 緊急連絡先

- **開発チーム**: [連絡先]
- **インフラチーム**: [連絡先]
- **セキュリティ専門家**: [連絡先]
- **法務チーム**: [連絡先]

---

**最終更新**: 2026年1月3日  
**次回見直し予定**: 2026年4月3日