# THLI-24 習慣レベルシステム マニュアルテストガイド

このドキュメントは、習慣・目標レベルシステム（THLI-24）の手動テストチェックリストです。
各テストシナリオを順番に実行し、期待される動作を確認してください。

## テスト環境

- **開発環境URL**: https://develop.do1k9oyyorn24.amplifyapp.com
- **開発API**: https://lyry9riumg.execute-api.ap-northeast-1.amazonaws.com/development

## 前提条件

- [ ] 開発環境にログインできること
- [ ] テスト用ユーザーアカウントが作成されていること
- [ ] フリープランとプレミアムプランの両方のテストユーザーがあること

---

## テストシナリオ 1: 習慣作成 → レベル評価 → 詳細表示 → 履歴確認

### 1.1 新規習慣の作成

**手順:**
1. ダッシュボードにログイン
2. 「習慣を追加」ボタンをクリック
3. 以下の情報で習慣を作成:
   - 名前: 「30分ジョギング」
   - タイプ: 「do」（実行する習慣）
   - 頻度: 「daily」（毎日）
   - ワークロード: 30

**期待される結果:**
- [ ] 習慣が正常に作成される
- [ ] 習慣カードに「Not Assessed」バッジが表示される
- [ ] 「レベル測定」ボタンが表示される

### 1.2 レベル評価の実行

**手順:**
1. 作成した習慣カードの「レベル測定」ボタンをクリック
2. AIコーチとの会話が開始される
3. THLI-24の質問に回答する（F01-F16の情報収集）
4. 評価完了まで会話を続ける

**期待される結果:**
- [ ] クォータ残量が表示される（例: 「今月の残り評価回数: 9/10」）
- [ ] AIコーチが習慣に関する質問を行う
- [ ] 評価完了後、Modal.AssessmentResultが表示される
- [ ] O/E/C レベル推定値が表示される（例: Lv.45-65）
- [ ] レベルティア（beginner/intermediate/advanced/expert）が表示される

### 1.3 レベル詳細の確認

**手順:**
1. 習慣カードのレベルバッジをクリック
2. Modal.LevelDetailsが開く

**期待される結果:**
- [ ] レベル番号とティアが表示される
- [ ] 24個のTHLI-24変数がスコアと共に表示される
- [ ] 各変数にストップライト（緑/黄/赤）が表示される
- [ ] O/E/C推定値が表示される
- [ ] クロスフレームワークスコア（TLX/SRBAI/COM-B）が表示される
- [ ] 評価日時が表示される

### 1.4 レベル履歴の確認

**手順:**
1. Modal.LevelDetails内の「履歴を見る」ボタンをクリック
2. Section.LevelHistoryが表示される

**期待される結果:**
- [ ] 縦型タイムラインでレベル変更履歴が表示される
- [ ] 各エントリに日付、旧レベル→新レベル、差分、理由が表示される
- [ ] フィルター機能（日付範囲、変更タイプ）が動作する
- [ ] 「CSVエクスポート」ボタンが機能する

---

## テストシナリオ 2: レベルアップフロー

### 2.1 レベルアップ候補の検出

**前提条件:**
- レベルが設定された習慣が存在する
- 過去30日間の完了率が90%以上
- 最後のレベル変更から30日以上経過

**手順:**
1. 上記条件を満たす習慣を用意（または手動でデータを設定）
2. レベルアップ検出ジョブを実行（または翌日の2:00 JSTを待つ）
3. ダッシュボードにログイン

**期待される結果:**
- [ ] 通知バッジに「レベル調整の提案があります」と表示される
- [ ] 提案一覧にレベルアップ候補が表示される

### 2.2 レベルアップの承認

**手順:**
1. レベルアップ提案をクリック
2. 提案内容を確認
3. 「承認」ボタンをクリック

**期待される結果:**
- [ ] 現在のレベルと目標レベルが表示される
- [ ] 具体的なワークロード変更が表示される（例: workload_per_count +20%）
- [ ] 承認後、習慣のワークロードが更新される
- [ ] level_historyに「level_up_progression」として記録される
- [ ] 習慣カードのレベルバッジが更新される

---

## テストシナリオ 3: レベルダウンとベビーステップ

### 3.1 レベルダウン候補の検出

**前提条件:**
- レベルが設定された習慣が存在する
- 過去14日間の完了率が50%未満
- 習慣がアクティブになってから14日以上経過

**手順:**
1. 上記条件を満たす習慣を用意
2. レベルダウン検出ジョブを実行
3. ダッシュボードにログイン

**期待される結果:**
- [ ] 通知バッジに提案数が表示される
- [ ] 提案一覧にレベルダウン候補が表示される

### 3.2 Lv.50ベビーステップの承認

**手順:**
1. レベルダウン提案をクリック
2. Modal.BabyStepPlanが表示される
3. Lv.50プランを選択
4. 「承認」ボタンをクリック

**期待される結果:**
- [ ] Lv.50とLv.10の2つのプランが並んで表示される
- [ ] 各プランで変更される変数の比較表が表示される
- [ ] Lv.50プランの目標レベル ≈ 現在レベル × 0.5
- [ ] 承認後、習慣のフィールドが更新される（頻度、ワークロード等）
- [ ] level_historyに「level_down_baby_step_lv50」として記録される
- [ ] 習慣名が簡略化される（例: 「30分ジョギング」→「15分ジョギング」）

### 3.3 Lv.10ベビーステップの確認

**手順:**
1. 別のレベルダウン提案でLv.10プランを選択

**期待される結果:**
- [ ] Lv.10プランの目標レベル ≤ 10
- [ ] ミニマル習慣の構成要素が表示される:
  - キュー（例: 「朝起きたら」）
  - アクション（例: 「玄関で靴を履く」）
  - 停止条件（例: 「靴を履いたら終わり」）
  - フォールバック（例: 「靴を履けなかったら、靴を見るだけでもOK」）
- [ ] 2分ルールが適用されている

---

## テストシナリオ 4: クォータ管理

### 4.1 フリーユーザーのクォータ確認

**手順:**
1. フリープランのユーザーでログイン
2. Widget.QuotaStatusを確認
3. GET /api/users/:id/thli-quota を呼び出す

**期待される結果:**
- [ ] 「THLI-24 assessments: X/10 remaining this month」と表示される
- [ ] APIレスポンスに以下が含まれる:
  - quota_used: 使用済み回数
  - quota_limit: 10
  - remaining: 残り回数
  - period_start: 月初日
  - period_end: 月末日

### 4.2 クォータ消費の確認

**手順:**
1. レベル評価を実行
2. 評価完了後、クォータを再確認

**期待される結果:**
- [ ] 評価成功時のみquota_usedが+1される
- [ ] 評価失敗やキャンセル時はquota_usedが変わらない
- [ ] Missingness Firewall発動時はquota_usedが変わらない

### 4.3 クォータ枯渇時のブロック

**手順:**
1. クォータを使い切る（10回評価を実行）
2. 追加の評価を試みる

**期待される結果:**
- [ ] 評価がブロックされる
- [ ] エラーメッセージ「今月の評価回数を使い切りました」が表示される
- [ ] upgrade_required: true がレスポンスに含まれる
- [ ] アップグレードページへのリンクが表示される

### 4.4 プレミアムユーザーの無制限クォータ

**手順:**
1. プレミアムプランのユーザーでログイン
2. Widget.QuotaStatusを確認

**期待される結果:**
- [ ] 「無制限」と表示される
- [ ] quota_limit = -1 がAPIレスポンスに含まれる
- [ ] 評価回数に制限がない

### 4.5 アップグレード後のブロック解除

**手順:**
1. クォータ枯渇状態のフリーユーザーをプレミアムにアップグレード
2. 評価を再試行

**期待される結果:**
- [ ] 評価がブロックされなくなる
- [ ] 「無制限」と表示される

---

## テストシナリオ 5: 日本語・英語プロンプトのテスト

### 5.1 日本語プロンプトでの評価

**手順:**
1. 言語設定を日本語に設定
2. 新しい習慣を作成
3. レベル評価を実行

**期待される結果:**
- [ ] AIコーチが日本語で質問する
- [ ] 技術用語（ICI, U0-U4, F01-F16等）は英語のまま
- [ ] 説明と例は日本語で表示される
- [ ] 評価結果が日本語で表示される

### 5.2 英語プロンプトでの評価

**手順:**
1. 言語設定を英語に設定
2. 新しい習慣を作成
3. レベル評価を実行

**期待される結果:**
- [ ] AIコーチが英語で質問する
- [ ] 評価結果が英語で表示される

### 5.3 言語間の一貫性確認

**手順:**
1. 同じ習慣情報を日本語と英語の両方で評価
2. 結果を比較

**期待される結果:**
- [ ] レベル推定値が±5ポイント以内で一致する
- [ ] ティア分類が一致する

---

## テストシナリオ 6: エラーハンドリング

### 6.1 API障害時のリトライ

**手順:**
1. OpenAI APIが一時的に利用不可の状態をシミュレート
2. レベル評価を実行

**期待される結果:**
- [ ] 最大3回のリトライが実行される
- [ ] リトライ間隔: 2秒、4秒、8秒
- [ ] 全リトライ失敗後、会話状態が保存される
- [ ] 「評価を一時保存しました。後で続きから再開できます」と表示される

### 6.2 評価の再開

**手順:**
1. 失敗した評価の「再開」ボタンをクリック

**期待される結果:**
- [ ] 前回の会話状態から再開される
- [ ] 既に回答した質問は再度聞かれない

### 6.3 Missingness Firewallの動作

**手順:**
1. レベル評価中に意図的に情報を不足させる
2. ICI < 0.6 になるようにする

**期待される結果:**
- [ ] Firewallが発動する
- [ ] エラーではなく「needs_more_data」ステータスになる
- [ ] VOI質問が生成される（最大5件）
- [ ] 質問はΔLv_upper順にランク付けされる

---

## テストシナリオ 7: 一括評価（習慣インベントリ）

### 7.1 一括評価の開始

**手順:**
1. 複数の未評価習慣を作成（5件以上）
2. 「すべての習慣を評価」ボタンをクリック
3. 確認モーダルで「開始」をクリック

**期待される結果:**
- [ ] クォータコストが表示される
- [ ] 進捗インジケーター「習慣評価中... (0/5 完了)」が表示される
- [ ] 推定残り時間が表示される
- [ ] 2秒間隔で順次評価が実行される

### 7.2 一括評価の完了

**手順:**
1. 一括評価が完了するまで待つ

**期待される結果:**
- [ ] サマリーレポートが表示される:
  - 評価完了数
  - レベル分布ヒストグラム（beginner: X, intermediate: Y, advanced: Z, expert: W）
  - 平均レベル
  - データ不足で保留中の習慣リスト

### 7.3 一括評価の中断と再開

**手順:**
1. 一括評価中に「キャンセル」ボタンをクリック
2. 後で「再開」ボタンをクリック

**期待される結果:**
- [ ] 進捗が保存される
- [ ] 再開時、最後に評価した習慣の次から継続される
- [ ] 既に評価済みの習慣は再評価されない

---

## テストシナリオ 8: UIコンポーネントの確認

### 8.1 LevelBadgeコンポーネント

**確認項目:**
- [ ] レベル番号が表示される
- [ ] ティアに応じた色が適用される:
  - beginner (0-49): 緑 (bg-success)
  - intermediate (50-99): 青 (bg-primary)
  - advanced (100-149): オレンジ (bg-warning)
  - expert (150-199): 赤 (bg-destructive)
- [ ] 未評価時は「Not Assessed」とグレーで表示される
- [ ] モバイル（< 768px）ではコンパクト表示
- [ ] 最近のレベル変更（7日以内）にはデルタ表示（+5, -10等）

### 8.2 目標レベルの集約表示

**手順:**
1. 子習慣を持つ目標を作成
2. 子習慣のレベルを評価

**期待される結果:**
- [ ] 目標カードにレベルバッジが表示される
- [ ] 目標レベル = MAX(子習慣レベル)
- [ ] 「Goal Level (from habits)」ラベルが表示される

---

## テスト完了チェックリスト

| シナリオ | ステータス | テスト日 | テスター | 備考 |
|---------|----------|---------|---------|------|
| 1. 習慣作成→評価→詳細→履歴 | ⬜ | | | |
| 2. レベルアップフロー | ⬜ | | | |
| 3. レベルダウン・ベビーステップ | ⬜ | | | |
| 4. クォータ管理 | ⬜ | | | |
| 5. 日本語・英語プロンプト | ⬜ | | | |
| 6. エラーハンドリング | ⬜ | | | |
| 7. 一括評価 | ⬜ | | | |
| 8. UIコンポーネント | ⬜ | | | |

---

## 問題報告テンプレート

問題が見つかった場合は、以下の形式で報告してください：

```markdown
### 問題タイトル

**シナリオ:** (例: 2.2 レベルアップの承認)
**環境:** 開発 / 本番
**ブラウザ:** Chrome / Safari / Firefox
**デバイス:** PC / モバイル

**再現手順:**
1. 
2. 
3. 

**期待される動作:**


**実際の動作:**


**スクリーンショット:**
(あれば添付)

**コンソールエラー:**
(あれば添付)
```

---

## 関連ドキュメント

- [要件定義書](.kiro/specs/habit-goal-level-system/requirements.md)
- [設計書](.kiro/specs/habit-goal-level-system/design.md)
- [タスク一覧](.kiro/specs/habit-goal-level-system/tasks.md)
- [デプロイ手順](./DEPLOYMENT_GUIDE.md)
