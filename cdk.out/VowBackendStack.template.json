{
 "Description": "Backend Lambda Stack for Vow Habit Tracking",
 "Resources": {
  "BackendLambdaRole563BEADE": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "Description": "Execution role for backend Lambda",
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/BackendLambdaRole/Resource"
   }
  },
  "BackendLogGroupDA10F1B2": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "LogGroupName": "/aws/lambda/vow-backend",
    "RetentionInDays": 14
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/BackendLogGroup/Resource"
   }
  },
  "BackendFunction63314140": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": "cdk-hnb659fds-assets-257784614320-ap-northeast-1",
     "S3Key": "d6aa0774aedac8022274e84303575f0b285a4fdbf1b6aac380a3221af3c6a3bc.zip"
    },
    "Description": "TypeScript backend for Vow habit tracking (Hono framework)",
    "Environment": {
     "Variables": {
      "NODE_ENV": "production",
      "SUPABASE_URL": "SET_VIA_CONSOLE",
      "SUPABASE_SERVICE_ROLE_KEY": "SET_VIA_CONSOLE",
      "JWT_SECRET": "SET_VIA_CONSOLE",
      "SLACK_CLIENT_ID": "SET_VIA_CONSOLE",
      "SLACK_CLIENT_SECRET": "SET_VIA_CONSOLE",
      "SLACK_SIGNING_SECRET": "SET_VIA_CONSOLE",
      "TOKEN_ENCRYPTION_KEY": "SET_VIA_CONSOLE",
      "CORS_ORIGINS": "http://localhost:3000,https://develop.d1234567890.amplifyapp.com"
     }
    },
    "FunctionName": "vow-backend",
    "Handler": "lambda-package/lambda.handler",
    "LoggingConfig": {
     "LogGroup": {
      "Ref": "BackendLogGroupDA10F1B2"
     }
    },
    "MemorySize": 512,
    "Role": {
     "Fn::GetAtt": [
      "BackendLambdaRole563BEADE",
      "Arn"
     ]
    },
    "Runtime": "nodejs20.x",
    "Timeout": 30
   },
   "DependsOn": [
    "BackendLambdaRole563BEADE"
   ],
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/BackendFunction/Resource",
    "aws:asset:path": "asset.d6aa0774aedac8022274e84303575f0b285a4fdbf1b6aac380a3221af3c6a3bc",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "BackendHttpApi557A99DF": {
   "Type": "AWS::ApiGatewayV2::Api",
   "Properties": {
    "CorsConfiguration": {
     "AllowHeaders": [
      "*"
     ],
     "AllowMethods": [
      "GET",
      "POST",
      "PUT",
      "DELETE",
      "OPTIONS"
     ],
     "AllowOrigins": [
      "http://localhost:3000",
      "https://develop.d1234567890.amplifyapp.com"
     ],
     "MaxAge": 3600
    },
    "Description": "HTTP API for backend",
    "Name": "vow-backend-api",
    "ProtocolType": "HTTP"
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/BackendHttpApi/Resource"
   }
  },
  "BackendHttpApiDefaultStageB800BC66": {
   "Type": "AWS::ApiGatewayV2::Stage",
   "Properties": {
    "ApiId": {
     "Ref": "BackendHttpApi557A99DF"
    },
    "AutoDeploy": true,
    "StageName": "$default"
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/BackendHttpApi/DefaultStage/Resource"
   }
  },
  "BackendHttpApiANYproxyLambdaIntegration5F09785B": {
   "Type": "AWS::ApiGatewayV2::Integration",
   "Properties": {
    "ApiId": {
     "Ref": "BackendHttpApi557A99DF"
    },
    "IntegrationType": "AWS_PROXY",
    "IntegrationUri": {
     "Fn::GetAtt": [
      "BackendFunction63314140",
      "Arn"
     ]
    },
    "PayloadFormatVersion": "2.0"
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/BackendHttpApi/ANY--{proxy+}/LambdaIntegration/Resource"
   }
  },
  "BackendHttpApiANYproxyLambdaIntegrationPermissionCE48D5F8": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "BackendFunction63314140",
      "Arn"
     ]
    },
    "Principal": "apigateway.amazonaws.com",
    "SourceArn": {
     "Fn::Join": [
      "",
      [
       "arn:",
       {
        "Ref": "AWS::Partition"
       },
       ":execute-api:ap-northeast-1:257784614320:",
       {
        "Ref": "BackendHttpApi557A99DF"
       },
       "/*/*/{proxy+}"
      ]
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/BackendHttpApi/ANY--{proxy+}/LambdaIntegration-Permission"
   }
  },
  "BackendHttpApiANYproxy1A04B814": {
   "Type": "AWS::ApiGatewayV2::Route",
   "Properties": {
    "ApiId": {
     "Ref": "BackendHttpApi557A99DF"
    },
    "AuthorizationType": "NONE",
    "RouteKey": "ANY /{proxy+}",
    "Target": {
     "Fn::Join": [
      "",
      [
       "integrations/",
       {
        "Ref": "BackendHttpApiANYproxyLambdaIntegration5F09785B"
       }
      ]
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/BackendHttpApi/ANY--{proxy+}/Resource"
   }
  },
  "BackendHttpApiANYLambdaIntegrationPermission3F1FA63E": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "BackendFunction63314140",
      "Arn"
     ]
    },
    "Principal": "apigateway.amazonaws.com",
    "SourceArn": {
     "Fn::Join": [
      "",
      [
       "arn:",
       {
        "Ref": "AWS::Partition"
       },
       ":execute-api:ap-northeast-1:257784614320:",
       {
        "Ref": "BackendHttpApi557A99DF"
       },
       "/*/*/"
      ]
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/BackendHttpApi/ANY--/LambdaIntegration-Permission"
   }
  },
  "BackendHttpApiANYE994B127": {
   "Type": "AWS::ApiGatewayV2::Route",
   "Properties": {
    "ApiId": {
     "Ref": "BackendHttpApi557A99DF"
    },
    "AuthorizationType": "NONE",
    "RouteKey": "ANY /",
    "Target": {
     "Fn::Join": [
      "",
      [
       "integrations/",
       {
        "Ref": "BackendHttpApiANYproxyLambdaIntegration5F09785B"
       }
      ]
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/BackendHttpApi/ANY--/Resource"
   }
  },
  "ReminderCheckRule17B52CC0": {
   "Type": "AWS::Events::Rule",
   "Properties": {
    "Description": "Trigger reminder check every 5 minutes",
    "Name": "vow-reminder-check",
    "ScheduleExpression": "rate(5 minutes)",
    "State": "ENABLED",
    "Targets": [
     {
      "Arn": {
       "Fn::GetAtt": [
        "BackendFunction63314140",
        "Arn"
       ]
      },
      "Id": "Target0",
      "Input": "{\"source\":\"aws.scheduler\",\"detail-type\":\"reminder-check\"}"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/ReminderCheckRule/Resource"
   }
  },
  "ReminderCheckRuleAllowEventRuleVowBackendStackBackendFunction62513DAF7F765AFA": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "BackendFunction63314140",
      "Arn"
     ]
    },
    "Principal": "events.amazonaws.com",
    "SourceArn": {
     "Fn::GetAtt": [
      "ReminderCheckRule17B52CC0",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/ReminderCheckRule/AllowEventRuleVowBackendStackBackendFunction62513DAF"
   }
  },
  "FollowUpCheckRuleDCEB79A0": {
   "Type": "AWS::Events::Rule",
   "Properties": {
    "Description": "Trigger follow-up check every 15 minutes",
    "Name": "vow-follow-up-check",
    "ScheduleExpression": "rate(15 minutes)",
    "State": "ENABLED",
    "Targets": [
     {
      "Arn": {
       "Fn::GetAtt": [
        "BackendFunction63314140",
        "Arn"
       ]
      },
      "Id": "Target0",
      "Input": "{\"source\":\"aws.scheduler\",\"detail-type\":\"follow-up-check\"}"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/FollowUpCheckRule/Resource"
   }
  },
  "FollowUpCheckRuleAllowEventRuleVowBackendStackBackendFunction62513DAF2A024A0E": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "BackendFunction63314140",
      "Arn"
     ]
    },
    "Principal": "events.amazonaws.com",
    "SourceArn": {
     "Fn::GetAtt": [
      "FollowUpCheckRuleDCEB79A0",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/FollowUpCheckRule/AllowEventRuleVowBackendStackBackendFunction62513DAF"
   }
  },
  "WeeklyReportRule3E0F4A7C": {
   "Type": "AWS::Events::Rule",
   "Properties": {
    "Description": "Trigger weekly report check every 15 minutes",
    "Name": "vow-weekly-report",
    "ScheduleExpression": "rate(15 minutes)",
    "State": "ENABLED",
    "Targets": [
     {
      "Arn": {
       "Fn::GetAtt": [
        "BackendFunction63314140",
        "Arn"
       ]
      },
      "Id": "Target0",
      "Input": "{\"source\":\"aws.scheduler\",\"detail-type\":\"weekly-report\"}"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/WeeklyReportRule/Resource"
   }
  },
  "WeeklyReportRuleAllowEventRuleVowBackendStackBackendFunction62513DAFE745799C": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "BackendFunction63314140",
      "Arn"
     ]
    },
    "Principal": "events.amazonaws.com",
    "SourceArn": {
     "Fn::GetAtt": [
      "WeeklyReportRule3E0F4A7C",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/WeeklyReportRule/AllowEventRuleVowBackendStackBackendFunction62513DAF"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/11P22rDMAz9lr4rGk3YB7SDXWCwkn5AUVPN85LYwZIbivG/DycrjD2dm5COaqybR9xuaJaqu/TVYM+YjkpdDzTLKVkaMbV+YHj6dAUzDN4IpndvXoKPU/HvPMNA4/lCmJ6j69R6V9K//MBhtCLWuwzSnEiEVXBXAKTBfex61j0JA03WkPJMt2uN6VV12k22rChQ5FHJLK1WUqzWR13Zm1M2ge5n/8llLgNf2algauPve3HgnKFl8TF0DEutst06U/KPqFPUDIebfnn30OC2xmbzLdZWITq1I2O74g911xGmVgEAAA=="
   },
   "Metadata": {
    "aws:cdk:path": "VowBackendStack/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "LambdaFunctionArn": {
   "Description": "Lambda Function ARN",
   "Value": {
    "Fn::GetAtt": [
     "BackendFunction63314140",
     "Arn"
    ]
   },
   "Export": {
    "Name": "VowBackendLambdaArn"
   }
  },
  "ApiEndpoint": {
   "Description": "API Gateway HTTP API Endpoint",
   "Value": {
    "Fn::GetAtt": [
     "BackendHttpApi557A99DF",
     "ApiEndpoint"
    ]
   },
   "Export": {
    "Name": "VowBackendApiEndpoint"
   }
  },
  "LogGroupName": {
   "Description": "CloudWatch Log Group Name",
   "Value": {
    "Ref": "BackendLogGroupDA10F1B2"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}