# OAuth セキュリティ修正タスク

## Overview

OAuth リダイレクト管理機能の重大なセキュリティ脆弱性を修正するための必須タスク。これらの修正は実装開始前に完了する必要がある。

## 🔴 最優先タスク（実装前に必須）

- [x] 1. Client Secret セキュリティ強化
  - [x] 1.1 Client Secret ハッシュ化実装
    - bcryptライブラリを使用してclient_secretをハッシュ化
    - データベーススキーマにsaltフィールド追加
    - 既存の平文保存を廃止
    - _Security Risk: データベース侵害時の全クライアント漏洩_

  - [x] 1.2 Client Secret 検証ロジック実装
    - ハッシュ化されたシークレットの検証機能
    - 定数時間比較でタイミング攻撃を防止
    - _Security Risk: タイミング攻撃による推測_

- [x] 2. 認可コード再利用防止強化
  - [x] 2.1 認可コード使用済みチェック実装
    - 使用済みコードの厳密な検証ロジック
    - 使用後の即座な無効化処理
    - 再利用試行時のエラーレスポンス
    - _Security Risk: 認可コード傍受・再利用攻撃_

  - [x] 2.2 認可コード有効期限短縮
    - デフォルト10分から1分に短縮
    - 期限切れコードの自動削除
    - _Security Risk: 長時間有効なコードの悪用_

- [x] 3. PKCE 必須化実装
  - [x] 3.1 パブリッククライアントでのPKCE強制
    - client_typeフィールドをデータベースに追加
    - パブリッククライアントではPKCE必須チェック
    - S256メソッドのみ許可
    - _Security Risk: 認可コード傍受攻撃_

  - [x] 3.2 PKCE検証ロジック強化
    - code_challengeとcode_verifierの厳密な検証
    - SHA256ハッシュ検証の実装
    - _Security Risk: PKCE バイパス攻撃_

- [x] 4. レート制限実装
  - [x] 4.1 認可エンドポイントレート制限
    - 1分間に10回の認可試行制限
    - IPアドレス別とクライアント別の制限
    - Redis使用の分散レート制限
    - _Security Risk: ブルートフォース攻撃_

  - [x] 4.2 トークンエンドポイントレート制限
    - 1分間に5回のトークン要求制限
    - 失敗時の指数バックオフ実装
    - _Security Risk: トークン総当たり攻撃_

  - [x] 4.3 API エンドポイントレート制限
    - 1時間に1000回のAPI呼び出し制限
    - クライアントアプリケーション別制限
    - _Security Risk: API乱用・DDoS攻撃_

## 🟡 高優先タスク（MVP後すぐに実装）

- [ ] 5. トークンセキュリティ強化
  - [ ] 5.1 JWT トークン実装
    - アクセストークンをJWT形式に変更
    - RS256署名アルゴリズム使用
    - トークン内にスコープ情報埋め込み
    - _Security Risk: トークン改ざん・偽造_

  - [ ] 5.2 トークン暗号化実装
    - JWE（JSON Web Encryption）使用
    - AES-256-GCM暗号化
    - _Security Risk: トークン内容漏洩_

  - [ ] 5.3 リフレッシュトークンローテーション
    - 使用時に新しいリフレッシュトークン発行
    - 古いトークンの即座無効化
    - _Security Risk: リフレッシュトークン漏洩_

- [ ] 6. 監査ログセキュリティ
  - [ ] 6.1 ログ改ざん防止実装
    - ログエントリのハッシュ値計算
    - チェーン化によるログ整合性保証
    - _Security Risk: 監査ログ改ざん_

  - [ ] 6.2 機密情報のハッシュ化
    - User-Agentのハッシュ化
    - IPアドレスの部分マスキング
    - _Security Risk: 個人情報漏洩_

- [ ] 7. セキュリティヘッダー実装
  - [ ] 7.1 HTTPS強制ヘッダー
    - Strict-Transport-Security実装
    - HSTS preloadリスト対応
    - _Security Risk: 中間者攻撃_

  - [ ] 7.2 XSS・CSRF防止ヘッダー
    - Content-Security-Policy設定
    - X-Frame-Options: DENY
    - SameSite Cookie設定
    - _Security Risk: XSS・CSRF攻撃_

## 🟢 中優先タスク（段階的実装）

- [ ] 8. 入力検証強化
  - [ ] 8.1 リダイレクトURI厳密検証
    - URL解析による詳細検証
    - フラグメント識別子の禁止
    - ローカルホスト以外でのHTTP禁止
    - _Security Risk: オープンリダイレクト攻撃_

  - [ ] 8.2 SQLインジェクション防止
    - パラメータ化クエリの徹底
    - 入力サニタイゼーション
    - _Security Risk: データベース侵害_

- [ ] 9. 暗号化強化
  - [ ] 9.1 暗号学的に安全な乱数生成
    - crypto.randomBytes使用
    - エントロピー不足対策
    - _Security Risk: 予測可能なトークン生成_

  - [ ] 9.2 鍵管理システム実装
    - 暗号化キーのローテーション
    - HSM（Hardware Security Module）対応
    - _Security Risk: 暗号化キー漏洩_

- [ ] 10. セッション管理強化
  - [ ] 10.1 セッションセキュリティ
    - セッション固定攻撃防止
    - セッションタイムアウト実装
    - _Security Risk: セッションハイジャック_

  - [ ] 10.2 セキュアクッキー設定
    - HttpOnly, Secure, SameSite設定
    - クッキーの暗号化
    - _Security Risk: クッキー盗取_

## セキュリティテストタスク

- [ ] 11. 自動セキュリティテスト実装
  - [ ] 11.1 認可コード再利用テスト
    - 使用済みコードの再利用試行テスト
    - エラーレスポンス検証
    - _Test: Property-based test for code reuse prevention_

  - [ ] 11.2 PKCE バイパステスト
    - PKCE なしでの認可試行テスト
    - 不正なcode_verifier検証テスト
    - _Test: Property-based test for PKCE enforcement_

  - [ ] 11.3 レート制限テスト
    - 制限値超過時の動作テスト
    - 分散環境でのレート制限テスト
    - _Test: Property-based test for rate limiting_

- [ ] 12. ペネトレーションテスト
  - [ ] 12.1 OAuth フロー攻撃テスト
    - 認可コード傍受攻撃
    - CSRF攻撃
    - リダイレクトURI操作攻撃
    - _Test: Manual penetration testing_

  - [ ] 12.2 API セキュリティテスト
    - トークン偽造攻撃
    - 権限昇格攻撃
    - SQLインジェクション攻撃
    - _Test: Automated security scanning_

## 実装順序

### Phase 1: 緊急修正（実装開始前）
1. Client Secret ハッシュ化
2. 認可コード再利用防止
3. PKCE 必須化
4. 基本レート制限

### Phase 2: セキュリティ強化（MVP後1週間以内）
5. JWT トークン実装
6. 監査ログセキュリティ
7. セキュリティヘッダー

### Phase 3: 包括的セキュリティ（MVP後1ヶ月以内）
8. 入力検証強化
9. 暗号化強化
10. セッション管理強化

### Phase 4: セキュリティテスト（継続的）
11. 自動セキュリティテスト
12. ペネトレーションテスト

## 完了基準

各タスクは以下の基準を満たした時点で完了とする：

- [ ] セキュリティ要件の実装完了
- [ ] 対応するテストケースの実装
- [ ] セキュリティレビューの通過
- [ ] ドキュメントの更新

## 緊急度評価

- **🔴 Critical**: 実装前に必須（データ漏洩・不正アクセスリスク）
- **🟡 High**: MVP後すぐ（攻撃成功率高）
- **🟢 Medium**: 段階的実装（防御強化）

**注意**: 🔴 Critical タスクが未完了の場合、OAuth機能の本番リリースは禁止