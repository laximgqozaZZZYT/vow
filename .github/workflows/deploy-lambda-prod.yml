name: Deploy Lambda to AWS (Production)

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-lambda-prod.yml'
  workflow_dispatch:
    inputs:
      rollback:
        description: 'Rollback to previous version'
        required: false
        default: false
        type: boolean
      version:
        description: 'Version to rollback to (e.g., 1, 2, $LATEST)'
        required: false
        default: ''
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1
  LAMBDA_FUNCTION_NAME: vow-production-api
  ENVIRONMENT: production

jobs:
  # =================================================================
  # Validate Secrets
  # =================================================================
  validate-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          MISSING_SECRETS=""
          
          if [ -z "${{ secrets.AWS_LAMBDA_DEPLOY_ROLE_ARN }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS AWS_LAMBDA_DEPLOY_ROLE_ARN"
          fi
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "‚ùå Missing required secrets:$MISSING_SECRETS"
            echo ""
            echo "Please configure these secrets in GitHub repository settings:"
            echo "Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            exit 1
          fi
          
          echo "‚úÖ All required secrets are configured"

  # =================================================================
  # Test
  # =================================================================
  test:
    needs: validate-secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.rollback != true
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'
      
      - name: Install dependencies
        run: cd backend && npm ci
      
      - name: Run linting
        run: cd backend && npm run lint --if-present
      
      - name: Run tests
        run: cd backend && npm test --if-present
        env:
          NODE_ENV: test

  # =================================================================
  # Build
  # =================================================================
  build:
    needs: [validate-secrets, test]
    runs-on: ubuntu-latest
    if: |
      always() && 
      needs.validate-secrets.result == 'success' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.rollback != true))
    outputs:
      package_hash: ${{ steps.package.outputs.hash }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'
      
      - name: Install dependencies
        run: cd backend && npm ci --production
      
      - name: Build TypeScript
        run: cd backend && npm run build --if-present
      
      - name: Create deployment package
        id: package
        run: |
          cd backend
          
          # Create package directory
          mkdir -p lambda-package
          
          # Copy built files
          if [ -d "dist" ]; then
            cp -r dist/* lambda-package/
          fi
          
          # Copy package.json for dependencies
          cp package.json lambda-package/
          
          # Install production dependencies in package
          cd lambda-package
          npm ci --production --ignore-scripts
          
          # Create zip
          zip -r ../lambda-deployment.zip .
          cd ..
          
          # Calculate hash
          HASH=$(sha256sum lambda-deployment.zip | cut -d' ' -f1 | head -c 8)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "üì¶ Package hash: $HASH"
          echo "üì¶ Package size: $(du -h lambda-deployment.zip | cut -f1)"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package-prod-${{ steps.package.outputs.hash }}
          path: backend/lambda-deployment.zip
          retention-days: 14

  # =================================================================
  # Deploy
  # =================================================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.rollback != true)
    environment: production
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_LAMBDA_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: lambda-package-prod-${{ needs.build.outputs.package_hash }}
          path: .
      
      - name: Get current version (for rollback)
        id: current-version
        run: |
          CURRENT_VERSION=$(aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --query 'Configuration.Version' \
            --output text 2>/dev/null || echo "0")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "üìã Current version: $CURRENT_VERSION"
      
      - name: Deploy to Lambda
        id: deploy
        run: |
          # Update function code
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://lambda-deployment.zip \
            --publish
          
          # Wait for update to complete
          echo "‚è≥ Waiting for Lambda update to complete..."
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
          
          # Get new version
          NEW_VERSION=$(aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --query 'Configuration.Version' \
            --output text)
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployed version: $NEW_VERSION"
      
      - name: Update alias (production)
        run: |
          # Update or create production alias
          aws lambda update-alias \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --name production \
            --function-version ${{ steps.deploy.outputs.new_version }} \
            2>/dev/null || \
          aws lambda create-alias \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --name production \
            --function-version ${{ steps.deploy.outputs.new_version }}
          
          echo "‚úÖ Updated production alias to version ${{ steps.deploy.outputs.new_version }}"
      
      - name: Verify deployment
        run: |
          # Invoke health check
          RESPONSE=$(aws lambda invoke \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }}:production \
            --payload '{"httpMethod": "GET", "path": "/health", "headers": {}, "queryStringParameters": null, "body": null}' \
            --cli-binary-format raw-in-base64-out \
            response.json)
          
          STATUS_CODE=$(echo $RESPONSE | jq -r '.StatusCode')
          
          if [ "$STATUS_CODE" == "200" ]; then
            echo "‚úÖ Health check passed"
            cat response.json
          else
            echo "‚ö†Ô∏è Health check returned status: $STATUS_CODE"
            cat response.json
          fi

  # =================================================================
  # Rollback
  # =================================================================
  rollback:
    needs: validate-secrets
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.rollback == true
    environment: production
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_LAMBDA_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: List available versions
        id: list-versions
        run: |
          echo "üìã Available versions:"
          aws lambda list-versions-by-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --query 'Versions[*].[Version, LastModified]' \
            --output table
      
      - name: Rollback to specified version
        run: |
          TARGET_VERSION="${{ github.event.inputs.version }}"
          
          if [ -z "$TARGET_VERSION" ]; then
            # Get previous version (second to last)
            TARGET_VERSION=$(aws lambda list-versions-by-function \
              --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
              --query 'Versions[-2].Version' \
              --output text)
          fi
          
          if [ -z "$TARGET_VERSION" ] || [ "$TARGET_VERSION" == "None" ]; then
            echo "‚ùå No previous version found for rollback"
            exit 1
          fi
          
          echo "üîÑ Rolling back to version: $TARGET_VERSION"
          
          # Update production alias to previous version
          aws lambda update-alias \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --name production \
            --function-version $TARGET_VERSION
          
          echo "‚úÖ Rolled back production alias to version $TARGET_VERSION"
      
      - name: Verify rollback
        run: |
          # Invoke health check
          RESPONSE=$(aws lambda invoke \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }}:production \
            --payload '{"httpMethod": "GET", "path": "/health", "headers": {}, "queryStringParameters": null, "body": null}' \
            --cli-binary-format raw-in-base64-out \
            response.json)
          
          echo "üìã Health check response:"
          cat response.json

  # =================================================================
  # Notify
  # =================================================================
  notify:
    needs: [deploy, rollback]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Configure AWS credentials (OIDC)
        if: (needs.deploy.result == 'success' || needs.deploy.result == 'failure') || (needs.rollback.result == 'success' || needs.rollback.result == 'failure')
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_LAMBDA_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Send SNS Notification
        if: (needs.deploy.result == 'success' || needs.deploy.result == 'failure') || (needs.rollback.result == 'success' || needs.rollback.result == 'failure')
        run: |
          SNS_TOPIC_ARN="${{ secrets.SNS_ALERTS_TOPIC_ARN }}"
          
          if [ -z "$SNS_TOPIC_ARN" ]; then
            echo "‚ÑπÔ∏è SNS topic not configured, skipping notification"
            exit 0
          fi
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            MESSAGE="‚úÖ Production Lambda deployment completed successfully!\n\nFunction: ${{ env.LAMBDA_FUNCTION_NAME }}\nCommit: ${{ github.sha }}\nBranch: main"
            SUBJECT="[VOW] Production Deployment Success"
          elif [ "${{ needs.rollback.result }}" == "success" ]; then
            MESSAGE="üîÑ Production Lambda rollback completed successfully!\n\nFunction: ${{ env.LAMBDA_FUNCTION_NAME }}\nVersion: ${{ github.event.inputs.version }}"
            SUBJECT="[VOW] Production Rollback Success"
          else
            MESSAGE="‚ùå Production Lambda operation failed!\n\nFunction: ${{ env.LAMBDA_FUNCTION_NAME }}\nCommit: ${{ github.sha }}\n\nCheck GitHub Actions for details."
            SUBJECT="[VOW] Production Operation Failed"
          fi
          
          aws sns publish \
            --topic-arn "$SNS_TOPIC_ARN" \
            --message "$MESSAGE" \
            --subject "$SUBJECT" || echo "SNS notification failed (topic may not exist)"
      
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Production Lambda deployment completed successfully!"
            echo ""
            echo "üîó Environment: Production"
            echo "üì¶ Function: ${{ env.LAMBDA_FUNCTION_NAME }}"
            echo "üîÄ Branch: main"
            echo "üìù Commit: ${{ github.sha }}"
          elif [ "${{ needs.rollback.result }}" == "success" ]; then
            echo "‚úÖ Production Lambda rollback completed successfully!"
          else
            echo "‚ùå Production Lambda operation failed or was skipped"
          fi
